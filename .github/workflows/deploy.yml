name: Deploy to Mac Mini

on:
  push:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Stop existing server (if running)
      run: |
        pkill -f "app.py" || true
        pkill -f "gunicorn.*app:app" || true
        sleep 2
        
    - name: Test server manually first
      run: |
        echo "Testing basic functionality..."
        /usr/bin/python3 -c "
import os
print('Python working')
print('Movies path exists:', os.path.exists('/Volumes/plexlib/movies'))
print('Series path exists:', os.path.exists('/Volumes/plexlib/series'))
"
        
    - name: Deploy using startup script
      run: |
        chmod +x start_server.sh
        echo "Starting PlexDownloader..."
        nohup ./start_server.sh > deployment.log 2>&1 &
        sleep 10
        
    - name: Verify deployment
      run: |
        echo "Checking if server is responding..."
        curl -s http://localhost:8035/ > /dev/null && echo "✅ Server is running at http://192.168.178.38:8035" || echo "❌ Server not responding"
        echo "Check logs with: tail -f /Users/jelteadmin/PlexDownloader/deployment.log"