name: Deploy to Mac Mini

on:
  push:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Stop existing server
      run: |
        echo "ğŸ›‘ Stopping existing PlexDownloader processes..."
        pkill -f "app.py" || true
        pkill -f "gunicorn.*app:app" || true
        pkill -f "PlexDownloader" || true
        sleep 3
        
    - name: Setup and deploy
      run: |
        echo "ğŸ”§ Setting up PlexDownloader..."
        chmod +x start_server.sh diagnose.sh
        
        echo "ğŸ’¾ Checking drives..."
        [ -d "/Volumes/plexlib/movies" ] && echo "âœ… Movies: $(find /Volumes/plexlib/movies -name '*.mp4' -o -name '*.mkv' | wc -l | tr -d ' ') files" || echo "âŒ Movies drive missing"
        [ -d "/Volumes/plexlib/series" ] && echo "âœ… Series: $(find /Volumes/plexlib/series -maxdepth 2 -type d | wc -l | tr -d ' ') shows" || echo "âŒ Series drive missing"
        
        echo "ğŸš€ Starting PlexDownloader in background..."
        nohup ./start_server.sh > deployment.log 2>&1 &
        echo $! > server.pid
        
        echo "â³ Waiting for server to start..."
        sleep 15
        
    - name: Verify deployment
      run: |
        echo "ğŸ§ª Testing server response..."
        
        # Test with timeout
        if timeout 10 curl -s http://localhost:8035/ > /dev/null; then
          echo "âœ… PlexDownloader is running successfully!"
          echo "ğŸŒ Local access: http://localhost:8035"
          echo "ğŸŒ Network access: http://192.168.178.38:8035"
          echo "ğŸ“Š Server PID: $(cat server.pid 2>/dev/null || echo 'not found')"
        else
          echo "âŒ Server not responding, checking logs..."
          echo "--- Recent deployment logs ---"
          tail -20 deployment.log 2>/dev/null || echo "No deployment log found"
          exit 1
        fi
        
    - name: Deployment summary
      run: |
        echo "ğŸ¬ PlexDownloader Deployment Complete!"
        echo "========================================"
        echo "ğŸ“ Server: http://192.168.178.38:8035"
        echo "ğŸ“‹ Logs: tail -f /Users/jelteadmin/PlexDownloader/deployment.log"
        echo "ğŸ›‘ Stop: kill \$(cat /Users/jelteadmin/PlexDownloader/server.pid)"
        echo "ğŸ”„ Restart: cd /Users/jelteadmin/PlexDownloader && ./start_server.sh"